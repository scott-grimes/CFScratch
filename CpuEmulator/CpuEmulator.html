<!DOCTYPE html>
<html>
<title>Cpu Emulator Page</title></title>
<head><script src="CpuEmulator.js"
    type="text/javascript"></script>
    <script src="Screen.js"
    type="text/javascript"></script>
    <script src="Keyboard.js"
    type="text/javascript"></script>
<script src="Computer.js"
    type="text/javascript"></script><script>
/**
 * A CPU emulator
 */
    

    var C; //for computer
    var ROM = [];
    var intervalStepper;
function fetchTextFromFile(evt) {
    //Retrieve the first file
    var f = evt.target.files[0]; 
    if (f) {
      var r = new FileReader();
      r.onload = function(e) { 
	      var contents = e.target.result;
         
          contents = contents.split('\n');
          ROM = [];
          for(var i = 0;i<contents.length;i++){
              ROM.push(contents[i]);
          }
          showBinary();
          resetCPU();
      }
      r.readAsText(f);
      
    } else { 
      alert("Failed to load file");
    }
  }
    
function resetCPU(evt){
        C = new Computer();
        stopRunning();
        var canvas = document.getElementById("screen");
    var keyvaluebox = document.getElementById("key");
        var ctx = canvas.getContext("2d");
        C.createScreen(ctx);
        C.loadRom(ROM);
        C.poke(0,15);
        updateCPUValues();
        C.linkKeyboard(canvas,keyvaluebox);
            
        
}
    

function showBinary(){
    document.getElementById("ROM").value = '';
    for(var i = 0;i<ROM.length;i++)
        document.getElementById("ROM").value+=ROM[i]+'\n'
    
}
    function showAssembly(){
        document.getElementById("ROM").value = '';
    for(var i = 0;i<ROM.length;i++)
        document.getElementById("ROM").value+=C.machineToAssembly(ROM[i])+'\n';
    }
       
function getA(){
    document.getElementById('A').value = C.CPU.A;
}
    function getPC(){
    document.getElementById('PC').value = C.CPU.PC;
}
    function getD(){
    document.getElementById('D').value = C.CPU.D;
}
    function getAluOut(){
    document.getElementById('ALUOUT').value = C.CPU.ALUOUT;
}
function getMemory(){
        var m = C.getMemory();
        document.getElementById('RAM').value = '';
        for (var key in m) {
            document.getElementById('RAM').value+=key+': '+m[key]+'\n';
        }
}
function updateCPUValues(){
        getA();
        getPC();
        getD();
        getAluOut();
        getMemory();
    }
function step(evt){
        if(C){
            C.execute();
            updateCPUValues();
        }
    }

function stopRunning() {
    clearInterval(intervalStepper);
    updateCPUValues();
}
    
function run(evt){
        document.getElementById('A').value= '';
        document.getElementById('D').value = '';
        document.getElementById('PC').value = '';
        document.getElementById('ALUOUT').value = '';
        
            intervalStepper = setInterval(function(){ 
                try{
            for(var i = 0;i<1000;i++){
                C.execute();
            }
            }catch(err){
        console.log(err);
        stopRunning();
    }}, 10);
        
    
    }

window.onload = function() {
    
   
    
  var initialvalue = "0100000000000000\n\
1110110000010000\n\
0000000000010000\n\
1110001100001000\n\
1110111010010000\n\
0000000000010001\n\
1110001100001000\n\
0110000000000000\n\
1111110000010000\n\
0000000000001101\n\
1110001100000001\n\
0000000000011011\n\
1110101010000111\n\
0000000000010000\n\
1111110000010000\n\
0110000000000000\n\
1110000111010000\n\
0000000000000111\n\
1110001100000110\n\
0000000000010001\n\
1111110000010000\n\
0000000000010000\n\
1111110111001000\n\
1111110010100000\n\
1110001100001000\n\
0000000000000111\n\
1110101010000111\n\
0000000000010000\n\
1111110000010000\n\
0100000000000000\n\
1110010011010000\n\
0000000000000111\n\
1110001100000100\n\
0000000000010000\n\
1111110010001000\n\
1111110111100000\n\
1110101010001000\n\
0000000000000111\n\
1110101010000111";
    
    
   document.getElementById("ROM").value = initialvalue;
    
   var blergaaa = initialvalue.split('\n');
          for(var i = 0;i<blergaaa.length;i++){
              ROM.push(blergaaa[i]);
          }
    window.r = ROM;
    
    resetCPU();
    
document.getElementById('fileUploader').addEventListener('change', fetchTextFromFile);
document.getElementById('resetbutton').addEventListener('click', resetCPU, false);
document.getElementById('stepbutton').addEventListener('click', step, false);
document.getElementById('runbutton').addEventListener('click', run,false);
document.getElementById('stopbutton').addEventListener('click', stopRunning,false);
document.getElementById('showBinary').addEventListener('click', showBinary,false);
document.getElementById('showAssembly').addEventListener('click', showAssembly,false);
   
   
    /*
   document.getElementById("runbutton").onclick = function () {
   var romboxvalue = document.getElementById("ROM").value;
   
   var m = document.getElementById("outputBox");
   var m1 = document.getElementById("compilerMessage");
   var answer;
   m1.value = 'Compiling...';
   try{
       m.value = '';
       var a = new Analyzer(jackTest);
       while(a.hasMoreTokens()){
           var token = a.advance();
           m.value += token+'\t\t\t('+a.tokenType(token)+')\n';
       }
       m1.value = 'Analyzed Successfully!'
   }
   catch(err){
       m.value = '';
       m1.value = 'Error: '+err;
   
   }
       
       
   m = document.getElementById("outputBox2");
   try{
       m.value = '';
       var a = new CompileJack(jackTest);
       for(var i = 0;i<a.lines.length;i++){
           m.value += a.lines[i]+'\n';
       }
       m1.value = 'Analyzed Successfully!'
   }
   catch(err){
       m1.value = 'Error: '+err;
   
   }
}
*/
}
    
</script>
</head>
<body>
<div class="row">
  <div class="column">
    Load your Binary or Assembly file, then step through your program.<br>
    <input id="fileUploader" name="myFile" type="file" accept=".asm, .hack"><br>
    ROM<br>
   <textarea id="ROM" rows="10" cols="20" readonly></textarea><br>
    View:  <button type="button" id="showBinary" >Binary</button>
      <button type="button" id="showAssembly" >Assembly</button><br>
    <button type="button" id="resetbutton" >Reset</button>
    <button type="button" id="stepbutton" >Step</button>
    <button type="button" id="runbutton" >Run</button><br>
      <button type="button" id="stopbutton" >Stop</button><br>
      PC: <textarea id="PC" rows="1" cols="10" readonly></textarea>
    </div>
  <div class="column">
      RAM<br>
    <textarea id="RAM" rows="10" cols="20" readonly></textarea><br>
      D: <textarea id="D" rows="1" cols="10" readonly></textarea>
      A: <textarea id="A" rows="1" cols="10" readonly></textarea>
      ALU Output: <textarea id="ALUOUT" rows="1" cols="10" readonly></textarea>
      Key: <textarea id="key" rows="1" cols="5" readonly></textarea>
    <canvas id="screen" tabindex="1" width="512" height="256"
style="border:1px solid #c3c3c3;">
Your browser does not support the canvas element.
</canvas>
    </div>
</div>
<br>
<input type="text" id="compilerMessage" size="44" readonly><br>
<br>


</body>
</html>
